import os
import h5py
import random
import numpy as np
import pdb
import torch
import torchvision.utils as utils
from torch.utils.data import Dataset
from torch.utils.data import DataLoader
from PIL import Image
import torchvision.transforms as transforms
from dataloader_scripts.random_pair import paired_data_augmentation

class DE_Train(Dataset):
    def __init__(self, mode='softtissue'):
        # self.root = '/home/bo/Projects/AccDiffusion/Data/DE/Proc_Data/'
        self.root = '/data22/user/yz2337/2024/AccDiffusion/Data/DE/Proc_Data/'

        self.mode = mode

        self.data_dir = os.path.join(self.root, 'Train')
        self.data_files = sorted([os.path.join(self.data_dir, f) for f in os.listdir(self.data_dir) if f.endswith('.h5')])

    def __getitem__(self, index):
        index = index % len(self.data_files)

        filename = self.data_files[index]

        if self.mode == 'softtissue':
            with h5py.File(filename, 'r') as f:
                IH = f['IH'][...]
                IS = f['IS'][...]

            input = IH
            target = IS

        elif self.mode == 'bone':
            with h5py.File(filename, 'r') as f:
                IH = f['IH'][...]
                IB = f['IB'][...]

            input = IH
            target = IB

        else:
            raise NotImplementedError

        if True:
            input, target = paired_data_augmentation(input, target)

        input = torch.from_numpy(input)
        target = torch.from_numpy(target)

        return target.unsqueeze(0), {'low_res': input.unsqueeze(0)}

    def __len__(self):
        return len(self.data_files) * 10


class DE_Test(Dataset):
    def __init__(self, mode='softtissue'):
        # self.root = '/home/bo/Projects/AccDiffusion/Data/DE/Proc_Data/'
        self.root = '/data22/user/yz2337/2024/AccDiffusion/Data/DE/Proc_Data/'

        self.mode = mode

        # self.data_dir = os.path.join(self.root, 'Test')
        self.data_dir = os.path.join(self.root, 'Test_w_PriorCNN')
        self.data_files = sorted([os.path.join(self.data_dir, f) for f in os.listdir(self.data_dir) if f.endswith('.h5')])

    def __getitem__(self, index):
        filename = self.data_files[index]

        if self.mode == 'softtissue':
            with h5py.File(filename, 'r') as f:
                IH = f['IH'][...]
                IS = f['IS'][...]
                IP = f['IP'][...]  # prior image generated by CNN

            input = IH
            target = IS
            prior = IP

        elif self.mode == 'bone':
            with h5py.File(filename, 'r') as f:
                IH = f['IH'][...]
                IB = f['IB'][...]
                IP = f['IP'][...]  # prior image generated by CNN

            input = IH
            target = IB
            prior = IP

        else:
            raise NotImplementedError

        input = torch.from_numpy(input)
        target = torch.from_numpy(target)
        prior = torch.from_numpy(prior)

        return target.unsqueeze(0), {'low_res': input.unsqueeze(0)}, prior.unsqueeze(0)

    def __len__(self):
        return len(self.data_files)
